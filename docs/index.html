<!DOCTYPE html>

<html>
<body>
    <link rel="stylesheet" type="text/css" href="style.css">
    <h1 id="smlapp-qr">SmlApp QR</h1>
    <p>Store a small application or game on a QR code!</p>
    <button onclick="location.href='https://github.com/benknight135/SmlApps-QR'" type="button">
        GitHub Repository</button>
    <p>The project repostiory has some example programs with scripts for
        making sure the builds are small. Remember a QR can only be so big!<br>Also included in this repository are programs
        for generating and reading the QR codes.<br>This project was inspired by MattKC&#39;s snakeqr <a
            href="https://itsmattkc.com/etc/snakeqr/">snakeqr</a></p>
    <h2 id="apps">Apps</h2>
    <h3 id="smlgame-by-ben-knight-">SmlGame (by Ben Knight)</h3>
    <p><img src="https://github.com/benknight135/SmlApps-QR/blob/master/apps/smlgame/releases/smlgame-v0.0.2/smlgame-v0.0.2-qr.png?raw=true" alt="Alt text"
            title="QR for SmlGame v0.0.2"></p>
    <h3 id="-snakeqr-https-itsmattkc-com-etc-snakeqr-by-mattkc-"><a href="https://itsmattkc.com/etc/snakeqr/">SnakeQR</a>
        (by MattKC)</h3>
    <p><img src="https://github.com/benknight135/SmlApps-QR/blob/master/apps/snakeqr/snakeqr.png?raw=true" alt="Alt text" title="QR for SnakeQR by MattKC"></p>
    <h2 id="read-qr">Read QR</h2>
    <p>Read a QR code from your computer webcam.<br>A script is provided to take the QR code and format it from the binary
        to a runnable exe.<br>Double click &#39;detectqr.bat&#39; in this repository to launch the detection.<br>Hold the QR
        code up to the camera and wait for the camera to read it. Once read the application should automatically start. </p>
    <p><img src="https://github.com/benknight135/SmlApps-QR/blob/master/docs/github/smlgame-demo-small.gif?raw=true" alt="Alt text" title="Demo QR reading of smlgame app"></p>
    <p>If you have more than one camera on your PC you may need to adjust which camera should be used. This can be set on
        the command line with the option --camera-index:</p>
    <pre><code><span class="hljs-keyword">cd</span> PATH_TO_REPO
    detectqr --camera-<span class="hljs-built_in">index</span> <span class="hljs-number">1</span>
    </code></pre>
    <p><em>Note: Make sure to replace PATH_TO_REPO with the path to this repository</em> </p>
    <h2 id="compatibility">Compatibility</h2>
    <p>All code in this repository will assume you are running Windows 10 x64 and have the following installed:</p>
    <ul>
        <li>Visual Studio 2015 (will work with other compilers but this is the one I used)</li>
    </ul>
    <h2 id="build-examples">Build examples</h2>
    <p>Scripts are provided for quick building of the applications in this repository.<br>Either run the
        &#39;build-<em>NAMEOFAPP</em>.bat&#39; file or run &#39;build-all.bat&#39; to build all the apps.<br>These scripts
        will use crinkler compressor as this gave the best results. </p>
    <h2 id="generate-qr">Generate QR</h2>
    <p>Using an applications exe we can generate a QR code.<br>This can be done using the qrencode application provided in
        this repository.<br>To generate a QR code of the smlgame application use &#39;createqr.bat&#39;.<br>Will use smlgame
        application by default but you can use this on your own exe:</p>
    <pre><code>cd PATH_TO_REPO
    createqr --<span class="hljs-selector-tag">input</span> apps\smlgame\smlgame<span class="hljs-selector-class">.exe</span> apps\smlgame\qr.png
    </code></pre>
    <p><em>Note: Make sure to replace PATH_TO_REPO with the path to this repository</em> </p>
    <p>Or do it all manually:</p>
    <pre><code>cd PATH_TO_REPO
    qr<span class="hljs-symbol">\c</span>onsole-qrencode<span class="hljs-symbol">\q</span>rencode<span class="hljs-symbol">\W</span>indows64<span class="hljs-symbol">\w</span>aqrencode.exe -i apps<span class="hljs-symbol">\s</span>mlgame<span class="hljs-symbol">\s</span>mlgame.exe -o apps<span class="hljs-symbol">\s</span>mlgame<span class="hljs-symbol">\q</span>r.png
    </code></pre>
    <p><em>Note: Make sure to replace PATH_TO_REPO with the path to this repository</em><br>This will output the QR code to
        a PNG image file. Print this off or save it onto your phone.<br>If this folder is missing make sure to pull
        submodules for this repository:</p>
    <pre><code>git submodule <span class="hljs-keyword">update</span> <span class="hljs-comment">--init</span>
    </code></pre>
    <h2 id="building-small-applications">Building small applications</h2>
    <p>Using msvc&#39;s &#39;cl&#39; and &#39;link&#39;, an app can be compiled and built.
        Here is an example of building &#39;smlgame&#39; using msvc. This should be run inside a <em>VS2015 x86 Native Tools
            Command Prompt</em>:</p>
    <pre><code>cd PATH_TO_REPO\smlgame
    cl /c /W4 /O1 /Os /GS- smlgame<span class="hljs-selector-class">.c</span>
    link /nologo /NODEFAULTLIB /ENTRY:WinMain /ALIGN:<span class="hljs-number">16</span> /SUBSYSTEM:windows /OUT:smlgame<span class="hljs-selector-class">.exe</span> smlgame<span class="hljs-selector-class">.obj</span> kernel32<span class="hljs-selector-class">.lib</span> user32<span class="hljs-selector-class">.lib</span> gdi32.lib
    </code></pre>
    <p><em>Note: Make sure to replace PATH_TO_REPO with the path to this repository</em></p>
    <p>To build this same app compressed, you can directly replace the linker with crinkler. Make sure to build inside an
        <strong>x86</strong> VS2015 shell otherwise crinkler will fail:</p>
    <pre><code>cd PATH_TO_REPO\smlgame
    cl /c /W4 /O1 /Os /GS- smlgame<span class="hljs-selector-class">.c</span>
    PATH_TO_REPO\crinkler /nologo /NODEFAULTLIB /ENTRY:WinMain /ALIGN:<span class="hljs-number">16</span> /SUBSYSTEM:windows /OUT:smlgame<span class="hljs-selector-class">.exe</span> smlgame<span class="hljs-selector-class">.obj</span> kernel32<span class="hljs-selector-class">.lib</span> user32<span class="hljs-selector-class">.lib</span> gdi32.lib
    </code></pre>
    <p><em>Note: Make sure to replace PATH_TO_REPO with the path to this repository</em></p>
    <h3 id="msvc-options">MSVC options</h3>
    <p>To give the app the best chance at being as small as possible options should be set for the linker and the compiler.
    </p>
    <h4 id="compiler">Compiler</h4>
    <p><strong>/O1</strong>: Creates small code.</p>
    <p><strong>/Os</strong>: Favors small code.</p>
    <p><strong>/GS-</strong>: Remove buffer overrun detection.</p>
    <h4 id="linker">Linker</h4>
    <p><strong>/nologo</strong>: Supress the startup banner. </p>
    <p><strong>/NODEFAULTLIB</strong>: Ignores all (or the specified) default libraries when external references are
        resolved. This means you have to link all the libraries yourself however cuts down on file size by only including
        the libraries actually being used. </p>
    <p><strong>/ALIGN:16</strong>: The <strong>/ALIGN</strong> option specifies the alignment of each section within the
        linear address space of the program. Programs normall have a lot of empty space as do not fill the data chunks. This
        reduces the size of each data chunk.<br><em>Warning: If using UPX or Petite this option cannot be used</em></p>
    <p><em>Note: If using Crinkler all these same options can be used however /nologo and /algin will be ignored. Crinkler
            does this automatically.</em></p>
    <h3 id="compressors">Compressors</h3>
    <h4 id="comparision">Comparision</h4>
    <p>A comparision was done using the smlgame application:</p>
    <table>
        <thead>
            <tr>
                <th>Compressor</th>
                <th>Size (Bytes)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Off</td>
                <td>2240</td>
            </tr>
            <tr>
                <td>Crinkler</td>
                <td>937</td>
            </tr>
            <tr>
                <td>UPX</td>
                <td>3584</td>
            </tr>
            <tr>
                <td>MPRESS</td>
                <td>2560</td>
            </tr>
            <tr>
                <td>Petite</td>
                <td>3396</td>
            </tr>
        </tbody>
    </table>
    <p>This shows Crinkler gives the best compression. This is mostly due to the other compressors being able to process
        custom alignment. Crinkler replaces the linker so was expected to before well. Of the compressors that run on the
        exe, MPRESS performed best due to being able to process custom alignment however ends up with a bigger file than the
        original.
        The comparision can be run within this repository using the &#39;compare-compressors.bat&#39; script. </p>
    <h4 id="crinkler">Crinkler</h4>
    <p>This compresser is a direct replacement for the linker.<br>Here is an example of using this compressor while
        building. This should be run inside a <em>VS2015 x86 Native Tools Command Prompt</em>:</p>
    <pre><code>cd PATH_TO_REPO\smlgame
    cl /c /W4 /O1 /Os /GS- smlgame<span class="hljs-selector-class">.c</span>
    PATH_TO_REPO\compressors\crinkler23\Win64\crinkler /nologo /NODEFAULTLIB /ENTRY:WinMain /ALIGN:<span class="hljs-number">16</span> /SUBSYSTEM:windows /OUT:smlgame<span class="hljs-selector-class">.exe</span> smlgame<span class="hljs-selector-class">.obj</span> kernel32<span class="hljs-selector-class">.lib</span> user32<span class="hljs-selector-class">.lib</span> gdi32.lib
    </code></pre>
    <p><em>Note: Make sure to replace PATH_TO_REPO with the path to this repository</em></p>
    <h4 id="mpress">MPRESS</h4>
    <p>This compressor is run on an exe or dll and tries to make it smaller. While testing this gave the best results of
        this type.
        Here is an example of using this compressor after building. This should be run inside a <em>VS2015 x86 Native Tools
            Command Prompt</em>:</p>
    <pre><code>cd PATH_TO_REPO\smlgame
    cl /c /W4 /O1 /Os /GS- smlgame<span class="hljs-selector-class">.c</span>
    link /nologo /NODEFAULTLIB /ENTRY:WinMain /ALIGN:<span class="hljs-number">16</span> /SUBSYSTEM:windows /OUT:smlgame<span class="hljs-selector-class">.exe</span> smlgame<span class="hljs-selector-class">.obj</span> kernel32<span class="hljs-selector-class">.lib</span> user32<span class="hljs-selector-class">.lib</span> gdi32<span class="hljs-selector-class">.lib</span>
    PATH_TO_REPO\compressors\mpress\mpress -s -x smlgame.exe
    </code></pre>
    <p>In this example the application is already smaller than mpress can improve on.
        <em>Note: Make sure to replace PATH_TO_REPO with the path to this repository</em> </p>
    <h4 id="upx">UPX</h4>
    <p>This compressor is run on an exe or dll and tries to make it smaller. While testing this gave the largest results as
        it does not allow the use of the custom allignment. This made the code 4x larger before compressing and was only
        able to compress a small amount.
        Here is an example of using this compressor after building. This should be run inside a <em>VS2015 x86 Native Tools
            Command Prompt</em>:</p>
    <pre><code>cd PATH_TO_REPO\smlgame
    cl /c /W4 /O1 /Os /GS- smlgame<span class="hljs-selector-class">.c</span>
    link /nologo /NODEFAULTLIB /ENTRY:WinMain /SUBSYSTEM:windows /OUT:smlgame<span class="hljs-selector-class">.exe</span> smlgame<span class="hljs-selector-class">.obj</span> kernel32<span class="hljs-selector-class">.lib</span> user32<span class="hljs-selector-class">.lib</span> gdi32<span class="hljs-selector-class">.lib</span>
    PATH_TO_REPO\compressors\upx-<span class="hljs-number">3.96</span>-win64\upx smlgame.exe
    </code></pre>
    <p><em>Note: Make sure to replace PATH_TO_REPO with the path to this repository</em> </p>
    <h4 id="petite">Petite</h4>
    <p>This compressor is run on an exe or dll and tries to make it smaller.
        Here is an example of using this compressor after building. This should be run inside a <em>VS2015 x86 Native Tools
            Command Prompt</em>:</p>
    <pre><code>cd PATH_TO_REPO\smlgame
    cl /c /W4 /O1 /Os /GS- smlgame<span class="hljs-selector-class">.c</span>
    link /nologo /NODEFAULTLIB /ENTRY:WinMain /ALIGN:<span class="hljs-number">16</span> /SUBSYSTEM:windows /OUT:smlgame<span class="hljs-selector-class">.exe</span> smlgame<span class="hljs-selector-class">.obj</span> kernel32<span class="hljs-selector-class">.lib</span> user32<span class="hljs-selector-class">.lib</span> gdi32<span class="hljs-selector-class">.lib</span>
    PATH_TO_REPO\compressors\petite24\petite smlgame.exe
    </code></pre>
    <p><em>Note: Make sure to replace PATH_TO_REPO with the path to this repository</em> </p>
    <h2 id="zbarcam">Zbarcam</h2>
    <p>Zbarcam is used for the qrcode detection. Zbar is currently maintained by mchehab <a
            href="https://github.com/mchehab/zbar">here</a>. This repository is included as a submodule of this repository
        for easy updating of the zbarcam application. </p>
    <h3 id="build">Build</h3>
    <p>Building of zbarcam for Windows x64 was not straight forward as the instructions on the github weren&#39;t quite
        right. See the README.md in the &#39;qr&#39; folder of this repository for updated instructions. </p>
    <h4 id="automatic">Automatic</h4>
    <p>To make this quick and easy, a build script is provided in the &#39;scripts&#39; folder. Run
        &#39;build-zbarcam.bat&#39; to install all the required packages and build zbarcam. <em>WARNING: This will overwrite
            the current zbarcam version in the &#39;zbarcam&#39; folder</em><br>This will install chocolatey with msys2,
        make and mingw. Then build zbar using msys2&#39;s bash.
        You will get some errors like:</p>
    <pre><code>cannot stat <span class="hljs-string">'./doc/man/zbarcam.1'</span>: <span class="hljs-keyword">No</span> such <span class="hljs-keyword">file</span> <span class="hljs-keyword">or</span> director
    </code></pre>
    <p>However these can be ignored as this is only for documentation</p>
    <h4 id="manual">Manual</h4>
    <p>Install chocolatey in an admin command prompt via powershell:</p>
    <pre><code>powershell -Command "[System.<span class="hljs-built_in">Net</span>.ServicePointManager]::SecurityProtocol = <span class="hljs-number">3072</span>; iex ((New-Object System.<span class="hljs-built_in">Net</span>.WebClient).DownloadString('https://chocolatey.org/install.ps1'))"
    </code></pre>
    <p>Restart the shell to reload environment varaibles.<br>Install msys2, make and mingw:</p>
    <pre><code><span class="hljs-attribute">choco</span> install -r --<span class="hljs-literal">no</span>-progress -y msys2 make mingw
    </code></pre>
    <p>Start a msys2 bash</p>
    <pre><code>msys2
    </code></pre>
    <p>In the msys2 bash terminal install required packages:</p>
    <pre><code>pacman -Syu <span class="hljs-comment">--noconfirm autoconf libtool automake make \</span>
        autoconf-archive pkg-config gettext-devel
    </code></pre>
    <p>Add mingw to path (in msys2)</p>
    <pre><code>export PATH=<span class="hljs-variable">$PATH</span><span class="hljs-symbol">:/c/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin</span>
    </code></pre>
    <p>Configure the zbar build (in msys2)</p>
    <pre><code><span class="hljs-comment">autoreconf</span> <span class="hljs-literal">-</span><span class="hljs-comment">vfi</span>

    <span class="hljs-string">.</span><span class="hljs-comment">/configure</span> <span class="hljs-comment">\</span>
    <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">host=x86_64</span><span class="hljs-literal">-</span><span class="hljs-comment">w64</span><span class="hljs-literal">-</span><span class="hljs-comment">mingw32</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">prefix=`pwd`/</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-comment">/zbarcam</span> <span class="hljs-comment">\</span>
    <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">without</span><span class="hljs-literal">-</span><span class="hljs-comment">gtk</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">without</span><span class="hljs-literal">-</span><span class="hljs-comment">python</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">without</span><span class="hljs-literal">-</span><span class="hljs-comment">qt</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">without</span><span class="hljs-literal">-</span><span class="hljs-comment">java</span> <span class="hljs-comment">\</span>
    <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">without</span><span class="hljs-literal">-</span><span class="hljs-comment">imagemagick</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">enable</span><span class="hljs-literal">-</span><span class="hljs-comment">pthread</span> <span class="hljs-comment">\</span>
        <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">with</span><span class="hljs-literal">-</span><span class="hljs-comment">directshow</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">disable</span><span class="hljs-literal">-</span><span class="hljs-comment">dependency</span><span class="hljs-literal">-</span><span class="hljs-comment">tracking</span>
    </code></pre>
    <p>Build and install zbar (in msys2)</p>
    <pre><code>make <span class="hljs-keyword">install</span>
    </code></pre>
    <p>This will build and install zbarcam to the zbarcam folder of this repository. This generates other files for using it
        as a library which can be removed.</p>
    <pre><code>cd PATH_TO_REPO
    xcopy /e /v /Y qr\zbarcam\bin qr\zbarcam
    rmdir /s /q qr\zbarcam\bin
    rmdir /s /q qr\zbarcam\<span class="hljs-keyword">include</span>
    rmdir /s /q qr\zbarcam\<span class="hljs-class"><span class="hljs-keyword">lib</span></span>
    rmdir /s /q qr\zbarcam\share
    </code></pre>
    <p><em>Note: Make sure to replace PATH_TO_REPO with the path to this repository</em> </p>

    <footer>(C) Ben Knight, 2020</footer>
</body>
</html>